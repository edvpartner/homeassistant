###############################################################################
# Reolink T√ºrklingel Integration
# Automatisierungen f√ºr T√ºrklingel mit Alexa-Ank√ºndigungen und Video-Stream
###############################################################################

# HINWEIS: Bitte ersetze die Entity-Namen mit deinen tats√§chlichen Reolink und Alexa Entity-IDs
# Du kannst die Entity-IDs in Home Assistant unter Entwicklertools -> Zust√§nde finden

###############################################################################
# KONFIGURATION - PASSE DIESE WERTE AN
###############################################################################

input_boolean:
  doorbell_announcements_enabled:
    name: T√ºrklingel-Ank√ºndigungen aktiviert
    icon: mdi:bell-ring
    initial: true

  doorbell_motion_announcements:
    name: Bewegungsank√ºndigungen aktiviert
    icon: mdi:walk
    initial: true

input_select:
  doorbell_announcement_volume:
    name: Ank√ºndigungs-Lautst√§rke
    options:
      - "Leise (3)"
      - "Normal (5)"
      - "Laut (7)"
      - "Sehr laut (9)"
    initial: "Normal (5)"
    icon: mdi:volume-high

input_number:
  doorbell_motion_cooldown:
    name: Bewegungs-Cooldown (Minuten)
    min: 1
    max: 30
    step: 1
    unit_of_measurement: "min"
    icon: mdi:timer-outline
    initial: 5

###############################################################################
# TEMPLATE SENSOREN
###############################################################################

template:
  - sensor:
      - name: "T√ºrklingel Letzter Klingel-Zeitstempel"
        unique_id: doorbell_last_ring_timestamp
        state: >
          {{ states('binary_sensor.reolink_doorbell_visitor') }}
        attributes:
          last_ring: >
            {% if is_state('binary_sensor.reolink_doorbell_visitor', 'on') %}
              {{ now().strftime('%H:%M:%S') }}
            {% else %}
              {{ state_attr('sensor.turklingel_letzter_klingel_zeitstempel', 'last_ring') }}
            {% endif %}

  - binary_sensor:
      - name: "Jemand vor der T√ºr"
        unique_id: someone_at_door
        state: >
          {{ is_state('binary_sensor.reolink_doorbell_motion', 'on') or 
             is_state('binary_sensor.reolink_doorbell_visitor', 'on') }}
        icon: >
          {% if is_state('binary_sensor.jemand_vor_der_tur', 'on') %}
            mdi:human-greeting
          {% else %}
            mdi:door-closed
          {% endif %}

###############################################################################
# AUTOMATISIERUNGEN
###############################################################################

automation:
  # Hauptautomatisierung: T√ºrklingel wurde gedr√ºckt
  - id: doorbell_ring_notification
    alias: "T√ºrklingel: Ank√ºndigung bei Klingeln"
    description: "Spielt Ank√ºndigung auf allen Echo-Ger√§ten und zeigt Stream auf Echo Shows"
    trigger:
      - platform: state
        entity_id: binary_sensor.reolink_doorbell_visitor
        to: "on"
    condition:
      - condition: state
        entity_id: input_boolean.doorbell_announcements_enabled
        state: "on"
    action:
      # Lautst√§rke ermitteln
      - variables:
          volume: >
            {% if is_state('input_select.doorbell_announcement_volume', 'Leise (3)') %}
              0.3
            {% elif is_state('input_select.doorbell_announcement_volume', 'Normal (5)') %}
              0.5
            {% elif is_state('input_select.doorbell_announcement_volume', 'Laut (7)') %}
              0.7
            {% else %}
              0.9
            {% endif %}

      # Ank√ºndigung auf ALLEN Alexa-Ger√§ten
      - service: notify.alexa_media
        data:
          message: "Es klingelt an der Haust√ºr. Jemand steht vor der T√ºr."
          data:
            type: announce
            method: all  # Auf allen Ger√§ten

      # Spezifische Ank√ºndigung mit Details auf bestimmten Ger√§ten
      # WICHTIG: Ersetze "media_player.echo_wohnzimmer" mit deinen Echo-Entity-IDs
      - service: notify.alexa_media_echo_wohnzimmer
        data:
          message: "Achtung! Es hat gerade an der Haust√ºr geklingelt."
          data:
            type: tts

      # Video-Stream auf Echo Show Ger√§ten anzeigen
      # WICHTIG: Ersetze die Entity-IDs mit deinen Echo Show Ger√§ten
      - service: camera.play_stream
        target:
          entity_id:
            - media_player.echo_show_kuche
            - media_player.echo_show_wohnzimmer
            - media_player.echo_show_schlafzimmer
        data:
          media_content_id: "camera.reolink_doorbell"
          media_content_type: "application/vnd.apple.mpegurl"

      # Alternative: Snapshot auf Echo Shows anzeigen
      - delay:
          seconds: 2
      - service: alexa_media.update_display
        target:
          entity_id:
            - media_player.echo_show_kuche
            - media_player.echo_show_wohnzimmer
        data:
          title: "Haust√ºr"
          body: "Jemand hat geklingelt"
          display_url: >
            {{ state_attr('camera.reolink_doorbell', 'entity_picture') }}

      # Mobile Benachrichtigung mit Snapshot
      - service: notify.mobile_app_your_phone
        data:
          title: "üîî T√ºrklingel"
          message: "Jemand hat an der Haust√ºr geklingelt"
          data:
            image: "/api/camera_proxy/camera.reolink_doorbell"
            tag: doorbell
            group: security
            priority: high
            ttl: 0
            actions:
              - action: "SHOW_CAMERA"
                title: "Kamera √∂ffnen"
              - action: "UNLOCK_DOOR"
                title: "T√ºr √∂ffnen"

      # Lichter einschalten als visuelles Signal (optional)
      - service: light.turn_on
        target:
          entity_id: light.eingangsbereich
        data:
          brightness: 255
          kelvin: 4000

      # Log-Eintrag erstellen
      - service: logbook.log
        data:
          name: "T√ºrklingel"
          message: "Es hat geklingelt um {{ now().strftime('%H:%M:%S') }}"
          entity_id: binary_sensor.reolink_doorbell_visitor

    mode: single

  # Bewegungserkennung vor der T√ºr
  - id: doorbell_motion_detection
    alias: "T√ºrklingel: Ank√ºndigung bei Bewegung"
    description: "Warnt BEVOR jemand klingelt"
    trigger:
      - platform: state
        entity_id: binary_sensor.reolink_doorbell_motion
        to: "on"
    condition:
      - condition: state
        entity_id: input_boolean.doorbell_motion_announcements
        state: "on"
      # Nicht ank√ºndigen wenn gerade geklingelt wurde (Cooldown)
      - condition: template
        value_template: >
          {% set last_ring = states('binary_sensor.reolink_doorbell_visitor') %}
          {% set last_change = as_timestamp(states.binary_sensor.reolink_doorbell_visitor.last_changed) %}
          {{ (as_timestamp(now()) - last_change) > 60 }}
    action:
      # Leise Ank√ºndigung auf ausgew√§hlten Ger√§ten
      - service: notify.alexa_media_echo_kuche
        data:
          message: "Achtung. Jemand n√§hert sich der Haust√ºr."
          data:
            type: announce

      - service: notify.alexa_media_echo_wohnzimmer
        data:
          message: "Bewegung an der Haust√ºr erkannt."
          data:
            type: announce

      # Diskretes Licht einschalten
      - service: light.turn_on
        target:
          entity_id: light.eingangsbereich
        data:
          brightness: 150
          kelvin: 3000

      # Mobile Benachrichtigung (leiser)
      - service: notify.mobile_app_your_phone
        data:
          title: "üëÅÔ∏è Bewegung an der Haust√ºr"
          message: "Jemand n√§hert sich der Haust√ºr"
          data:
            image: "/api/camera_proxy/camera.reolink_doorbell"
            tag: doorbell_motion
            group: security
            priority: default

    mode: single

  # Stream automatisch beenden nach 2 Minuten
  - id: doorbell_stop_stream
    alias: "T√ºrklingel: Stream automatisch beenden"
    description: "Beendet den Video-Stream nach 2 Minuten"
    trigger:
      - platform: state
        entity_id: binary_sensor.reolink_doorbell_visitor
        to: "on"
        for:
          minutes: 2
    action:
      - service: media_player.media_stop
        target:
          entity_id:
            - media_player.echo_show_kuche
            - media_player.echo_show_wohnzimmer
            - media_player.echo_show_schlafzimmer

    mode: single

  # Nachtmodus: Reduzierte Lautst√§rke zwischen 22:00 und 07:00
  - id: doorbell_night_mode
    alias: "T√ºrklingel: Nachtmodus"
    description: "Leise Ank√ºndigungen nachts"
    trigger:
      - platform: state
        entity_id: binary_sensor.reolink_doorbell_visitor
        to: "on"
    condition:
      - condition: state
        entity_id: input_boolean.doorbell_announcements_enabled
        state: "on"
      - condition: time
        after: "22:00:00"
        before: "07:00:00"
    action:
      # Nur leise Ank√ºndigung
      - service: notify.alexa_media
        data:
          message: "Jemand ist an der T√ºr."
          data:
            type: announce
            method: all

      # Kein Stream, nur Snapshot
      - service: notify.mobile_app_your_phone
        data:
          title: "üîî T√ºrklingel (Nachtmodus)"
          message: "Jemand hat geklingelt um {{ now().strftime('%H:%M') }}"
          data:
            image: "/api/camera_proxy/camera.reolink_doorbell"
            tag: doorbell_night
            group: security
            priority: high

    mode: single

  # Abwesenheitsmodus: Erweiterte Benachrichtigungen
  - id: doorbell_away_mode
    alias: "T√ºrklingel: Abwesenheitsmodus"
    description: "Besondere Benachrichtigungen wenn niemand zuhause"
    trigger:
      - platform: state
        entity_id: binary_sensor.reolink_doorbell_visitor
        to: "on"
    condition:
      # Pr√ºfe ob niemand zuhause ist
      - condition: state
        entity_id: zone.home
        state: "0"
    action:
      # Dringende Benachrichtigung
      - service: notify.mobile_app_your_phone
        data:
          title: "üö® T√ºrklingel - Niemand zuhause!"
          message: "Jemand hat geklingelt w√§hrend das Haus leer ist"
          data:
            image: "/api/camera_proxy/camera.reolink_doorbell"
            tag: doorbell_away
            group: security
            priority: high
            ttl: 0
            actions:
              - action: "VIEW_CAMERA"
                title: "Live-Stream √∂ffnen"
              - action: "CALL_POLICE"
                title: "Verd√§chtig? Polizei rufen"

      # Video-Clip speichern
      - service: camera.snapshot
        target:
          entity_id: camera.reolink_doorbell
        data:
          filename: "/config/www/doorbell_snapshots/{{ now().strftime('%Y%m%d_%H%M%S') }}.jpg"

      # Log mit Zeitstempel
      - service: logbook.log
        data:
          name: "T√ºrklingel - Abwesenheit"
          message: >
            WARNUNG: T√ºrklingel aktiviert w√§hrend niemand zuhause ist 
            ({{ now().strftime('%d.%m.%Y %H:%M:%S') }})
          entity_id: binary_sensor.reolink_doorbell_visitor

    mode: single

###############################################################################
# SKRIPTE f√ºr manuelle Aktionen
###############################################################################

script:
  doorbell_show_stream:
    alias: "T√ºrklingel: Stream manuell anzeigen"
    sequence:
      - service: camera.play_stream
        target:
          entity_id:
            - media_player.echo_show_kuche
            - media_player.echo_show_wohnzimmer
        data:
          media_content_id: "camera.reolink_doorbell"
          media_content_type: "application/vnd.apple.mpegurl"

  doorbell_take_snapshot:
    alias: "T√ºrklingel: Snapshot erstellen"
    sequence:
      - service: camera.snapshot
        target:
          entity_id: camera.reolink_doorbell
        data:
          filename: "/config/www/doorbell_snapshots/manual_{{ now().strftime('%Y%m%d_%H%M%S') }}.jpg"

      - service: notify.mobile_app_your_phone
        data:
          title: "üì∑ Snapshot gespeichert"
          message: "T√ºrklingel-Snapshot wurde manuell erstellt"

  doorbell_test_announcement:
    alias: "T√ºrklingel: Test-Ank√ºndigung"
    sequence:
      - service: notify.alexa_media
        data:
          message: "Dies ist eine Test-Ank√ºndigung der T√ºrklingel-Integration."
          data:
            type: announce
            method: all

###############################################################################
# DASHBOARD KARTE f√ºr Lovelace (optional)
###############################################################################

# F√ºge diese Karte zu deinem Dashboard hinzu:
#
# type: vertical-stack
# cards:
#   - type: custom:mushroom-title-card
#     title: T√ºrklingel
#     subtitle: Reolink Video Doorbell
#   
#   - type: picture-entity
#     entity: camera.reolink_doorbell
#     camera_view: live
#     aspect_ratio: 16:9
#     show_state: false
#     show_name: false
#     tap_action:
#       action: call-service
#       service: script.doorbell_show_stream
#   
#   - type: horizontal-stack
#     cards:
#       - type: custom:mushroom-entity-card
#         entity: binary_sensor.reolink_doorbell_visitor
#         name: Klingel-Status
#         icon: mdi:bell-ring
#         icon_color: red
#       
#       - type: custom:mushroom-entity-card
#         entity: binary_sensor.reolink_doorbell_motion
#         name: Bewegung
#         icon: mdi:motion-sensor
#         icon_color: amber
#   
#   - type: entities
#     entities:
#       - entity: input_boolean.doorbell_announcements_enabled
#         name: Ank√ºndigungen
#       - entity: input_boolean.doorbell_motion_announcements
#         name: Bewegungs-Ank√ºndigungen
#       - entity: input_select.doorbell_announcement_volume
#         name: Lautst√§rke
#       - entity: input_number.doorbell_motion_cooldown
#         name: Cooldown
#   
#   - type: horizontal-stack
#     cards:
#       - type: button
#         name: Stream zeigen
#         icon: mdi:video
#         tap_action:
#           action: call-service
#           service: script.doorbell_show_stream
#       
#       - type: button
#         name: Snapshot
#         icon: mdi:camera
#         tap_action:
#           action: call-service
#           service: script.doorbell_take_snapshot
#       
#       - type: button
#         name: Test
#         icon: mdi:test-tube
#         tap_action:
#           action: call-service
#           service: script.doorbell_test_announcement
